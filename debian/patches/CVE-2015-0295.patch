Backport of:

From 661f6bfd032dacc62841037732816a583640e187 Mon Sep 17 00:00:00 2001
From: Richard J. Moore <rich@kde.org>
Date: Sat, 21 Feb 2015 17:43:21 +0000
Subject: [PATCH] Fix a division by zero when processing malformed BMP files.

This fixes a division by 0 when processing a maliciously crafted BMP
file. No impact beyond DoS.

Task-number: QTBUG-44547
Change-Id: Ifcded2c0aa712e90d23e6b3969af0ec3add53973
Reviewed-by: Thiago Macieira <thiago.macieira@intel.com>
Reviewed-by: Oswald Buddenhagen <oswald.buddenhagen@theqtcompany.com>
---
 src/gui/image/qbmphandler.cpp |    8 ++++++++
 1 files changed, 8 insertions(+), 0 deletions(-)

Index: qt4-x11-4.8.1/src/gui/image/qbmphandler.cpp
===================================================================
--- qt4-x11-4.8.1.orig/src/gui/image/qbmphandler.cpp	2015-05-27 08:41:17.750075671 -0400
+++ qt4-x11-4.8.1/src/gui/image/qbmphandler.cpp	2015-05-27 08:41:17.746075625 -0400
@@ -321,10 +321,16 @@
         }
     } else if (comp == BMP_BITFIELDS && (nbits == 16 || nbits == 32)) {
         red_shift = calc_shift(red_mask);
+        if (((red_mask >> red_shift) + 1) == 0)
+            return false;
         red_scale = 256 / ((red_mask >> red_shift) + 1);
         green_shift = calc_shift(green_mask);
+        if (((green_mask >> green_shift) + 1) == 0)
+            return false;
         green_scale = 256 / ((green_mask >> green_shift) + 1);
         blue_shift = calc_shift(blue_mask);
+        if (((blue_mask >> blue_shift) + 1) == 0)
+            return false;
         blue_scale = 256 / ((blue_mask >> blue_shift) + 1);
     } else if (comp == BMP_RGB && (nbits == 24 || nbits == 32)) {
         blue_mask = 0x000000ff;
