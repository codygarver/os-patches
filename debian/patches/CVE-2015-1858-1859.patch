From 51ec7ebfe5f45d1c0a03d992e97053cac66e25fe Mon Sep 17 00:00:00 2001
From: Eirik Aavitsland <eirik.aavitsland@theqtcompany.com>
Date: Wed, 11 Mar 2015 13:34:01 +0100
Subject: [PATCH] Fixes crash in bmp and ico image decoding

Fuzzing test revealed that for certain malformed bmp and ico files,
the handler would segfault.

Change-Id: I19d45145f31e7f808f7f6a1a1610270ea4159cbe
Reviewed-by: Lars Knoll <lars.knoll@digia.com>
---
 src/gui/image/qbmphandler.cpp                |   13 +++++++------
 src/plugins/imageformats/ico/qicohandler.cpp |    2 +-
 2 files changed, 8 insertions(+), 7 deletions(-)

Index: qt4-x11-4.8.6+git64-g5dc8b2b+dfsg/src/gui/image/qbmphandler.cpp
===================================================================
--- qt4-x11-4.8.6+git64-g5dc8b2b+dfsg.orig/src/gui/image/qbmphandler.cpp	2015-05-25 13:34:52.883223566 -0400
+++ qt4-x11-4.8.6+git64-g5dc8b2b+dfsg/src/gui/image/qbmphandler.cpp	2015-05-25 13:34:52.879223529 -0400
@@ -478,12 +478,6 @@
                             p = data + (h-y-1)*bpl;
                             break;
                         case 2:                        // delta (jump)
-                            // Protection
-                            if ((uint)x >= (uint)w)
-                                x = w-1;
-                            if ((uint)y >= (uint)h)
-                                y = h-1;
-
                             {
                                 quint8 tmp;
                                 d->getChar((char *)&tmp);
@@ -491,6 +485,13 @@
                                 d->getChar((char *)&tmp);
                                 y += tmp;
                             }
+
+                            // Protection
+                            if ((uint)x >= (uint)w)
+                                x = w-1;
+                            if ((uint)y >= (uint)h)
+                                y = h-1;
+
                             p = data + (h-y-1)*bpl + x;
                             break;
                         default:                // absolute mode
Index: qt4-x11-4.8.6+git64-g5dc8b2b+dfsg/src/plugins/imageformats/ico/qicohandler.cpp
===================================================================
--- qt4-x11-4.8.6+git64-g5dc8b2b+dfsg.orig/src/plugins/imageformats/ico/qicohandler.cpp	2015-05-25 13:34:52.883223566 -0400
+++ qt4-x11-4.8.6+git64-g5dc8b2b+dfsg/src/plugins/imageformats/ico/qicohandler.cpp	2015-05-25 13:34:52.879223529 -0400
@@ -571,7 +571,7 @@
                 QImage::Format format = QImage::Format_ARGB32;
                 if (icoAttrib.nbits == 24)
                     format = QImage::Format_RGB32;
-                else if (icoAttrib.ncolors == 2)
+                else if (icoAttrib.ncolors == 2 && icoAttrib.depth == 1)
                     format = QImage::Format_Mono;
                 else if (icoAttrib.ncolors > 0)
                     format = QImage::Format_Indexed8;
