From d41dc3e101a694dec98d7bbb582d428d209e5401 Mon Sep 17 00:00:00 2001
From: Richard Moore <rich@kde.org>
Date: Fri, 14 Sep 2012 00:13:08 +0100
Subject: [PATCH] Disable SSL compression by default.

Disable SSL compression by default since this appears to be the a likely
cause of the currently hyped CRIME attack.

This is a backport of 5ea896fbc63593f424a7dfbb11387599c0025c74

Change-Id: I6eeefb23c6b140a9633b28ed85879459c474348a
Reviewed-by: Thiago Macieira <thiago.macieira@intel.com>
Reviewed-by: Peter Hartmann <phartmann@rim.com>


http://www.openwall.com/lists/oss-security/2012/10/03/2
http://permalink.gmane.org/gmane.comp.lib.qt.devel/6729

Index: qt4-x11-4.8.1/src/network/ssl/qssl.cpp
===================================================================
--- qt4-x11-4.8.1.orig/src/network/ssl/qssl.cpp	2012-03-14 07:01:30.000000000 -0700
+++ qt4-x11-4.8.1/src/network/ssl/qssl.cpp	2012-10-11 17:38:42.000000000 -0700
@@ -148,8 +148,9 @@
 
     By default, SslOptionDisableEmptyFragments is turned on since this causes
     problems with a large number of servers. SslOptionDisableLegacyRenegotiation
-    is also turned on, since it introduces a security risk. The other options
-    are turned off.
+    is also turned on, since it introduces a security risk.
+    SslOptionDisableCompression is turned on to prevent the attack publicised by
+    CRIME. The other options are turned off.
 
     Note: Availability of above options depends on the version of the SSL
     backend in use.
Index: qt4-x11-4.8.1/src/network/ssl/qsslconfiguration.cpp
===================================================================
--- qt4-x11-4.8.1.orig/src/network/ssl/qsslconfiguration.cpp	2012-03-14 07:01:30.000000000 -0700
+++ qt4-x11-4.8.1/src/network/ssl/qsslconfiguration.cpp	2012-10-11 17:38:42.000000000 -0700
@@ -201,7 +201,9 @@
             d->privateKey.isNull() &&
             d->peerCertificate.isNull() &&
             d->peerCertificateChain.count() == 0 &&
-            d->sslOptions == (QSsl::SslOptionDisableEmptyFragments|QSsl::SslOptionDisableLegacyRenegotiation));
+            d->sslOptions == ( QSsl::SslOptionDisableEmptyFragments
+                              |QSsl::SslOptionDisableLegacyRenegotiation
+                              |QSsl::SslOptionDisableCompression));
 }
 
 /*!
Index: qt4-x11-4.8.1/src/network/ssl/qsslconfiguration_p.h
===================================================================
--- qt4-x11-4.8.1.orig/src/network/ssl/qsslconfiguration_p.h	2012-03-14 07:01:30.000000000 -0700
+++ qt4-x11-4.8.1/src/network/ssl/qsslconfiguration_p.h	2012-10-11 17:38:42.000000000 -0700
@@ -83,7 +83,9 @@
         : protocol(QSsl::SecureProtocols),
           peerVerifyMode(QSslSocket::AutoVerifyPeer),
           peerVerifyDepth(0),
-          sslOptions(QSsl::SslOptionDisableEmptyFragments|QSsl::SslOptionDisableLegacyRenegotiation)
+          sslOptions(QSsl::SslOptionDisableEmptyFragments
+                     |QSsl::SslOptionDisableLegacyRenegotiation
+                     |QSsl::SslOptionDisableCompression)
     { }
 
     QSslCertificate peerCertificate;
